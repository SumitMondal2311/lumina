generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
  moduleFormat    = "cjs"
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector")] // Enable pgvector extension
}

model User {
  id                  String   @id @default(cuid())
  lastActiveProjectId String?
  email               String   @unique
  createdAt           DateTime @default(now())

  memberships ProjectMember[]

  @@map("users")
}

model Project {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  deletedAt DateTime?

  members ProjectMember[]
  videos  Video[]

  @@map("projects")
}

enum ProjectMemberRole {
  OWNER
  EDITOR
  VIEWER
}

model ProjectMember {
  userId    String
  projectId String
  role      ProjectMemberRole @default(VIEWER)
  createdAt DateTime          @default(now())

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])

  @@unique([userId, projectId])
  @@map("project_members")
}

enum VideoStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

model Video {
  id        String      @id @default(cuid())
  projectId String
  title     String      @default("Untitled")
  objectKey String      @unique // e.g., S3 object key
  status    VideoStatus @default(UPLOADING)
  duration  Float? // Duration in seconds
  createdAt DateTime    @default(now())

  captionsKey  String? // e.g., S3 object key for captions file
  thumbnailKey String? // e.g., S3 object key for thumbnail image
  metadata     Json? // Additional video metadata
  deletedAt    DateTime?

  chunks Chunk[]
  jobs   Job[]

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("videos")
}

// Chunks represent segments of transcribed text from videos, along with their embeddings for semantic search.
model Chunk {
  id        String                       @id @default(cuid())
  videoId   String
  startTime Float
  endTime   Float
  text      String                       @db.Text
  embedding Unsupported("vector(1536)")? // Vector embedding for semantic search, can be regenerated without re-transcribing

  video Video @relation(fields: [videoId], references: [id])

  @@map("chunks")
}

enum JobType {
  TRANSCODE // Convert video to a standard format
  GENERATE_THUMBNAIL // Create a thumbnail image from the video
  EXTRACT_AUDIO // Extract audio from video
  TRANSCRIBE // Convert audio to text
  GENERATE_CAPTIONS // Create caption from transcribed text
  GENERATE_EMBEDDINGS // Create embeddings for transcribed text
}

enum JobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// Jobs represent background tasks to be performed on videos, such as transcoding, transcription, etc.
model Job {
  id      String    @id @default(cuid())
  videoId String
  type    JobType
  status  JobStatus @default(PENDING)

  payload   Json? // Additional data for the job
  lastError String? @db.Text

  video Video @relation(fields: [videoId], references: [id])

  @@map("jobs")
}
